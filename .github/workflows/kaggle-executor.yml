name: Kaggle Notebook Executor

on:
  workflow_dispatch:
  repository_dispatch:
    types: [cron-trigger]

jobs:
  execute-notebooks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        pip install kaggle
    
    - name: Execute notebooks
      run: |
        python << 'PYEOF'
        import os
        import subprocess
        import json
        import sys
        from datetime import datetime
        from pathlib import Path
        import shutil
        import time

        # --- CONFIGURATION ---
        SOURCE_ACCOUNT = {
            "username": "shreevathsbbhh",
            "key": "9f167cdee8a045c97ca6a2f82c6701f9"
        }

        DEST_ACCOUNTS = {
            "vathsamm": {
                "username": "vathsamm",
                "key": "33fad3a4dc6d92aa70fa90b62b9ebef4"
            }
        }

        NOTEBOOKS = [
            {
                "source_slug": "shreevathsbbhh/long-google-tts-4", 
                "notebook_name": "long-google-tts-4", 
                "dest_slug": "vathsamm/long-google-tts-4",
                "dest_account": "vathsamm"
            },
            {
                "source_slug": "shreevathsbbhh/king-main-15", 
                "notebook_name": "king-main-15", 
                "dest_slug": "vathsamm/king-main-15",
                "dest_account": "vathsamm"
            }
        ]

        # --- FUNCTIONS ---

        def log(msg, symbol="‚ÑπÔ∏è"):
            timestamp = datetime.utcnow().strftime('%H:%M:%S')
            print(f"[{timestamp}] {symbol} {msg}")
            sys.stdout.flush()

        def setup_kaggle_auth(account):
            # Set up the directory
            kaggle_dir = Path.home() / ".kaggle"
            kaggle_dir.mkdir(exist_ok=True)
            
            # Write the file
            kaggle_json = kaggle_dir / "kaggle.json"
            with open(kaggle_json, 'w') as f:
                json.dump({"username": account["username"], "key": account["key"]}, f)
            
            # Set permissions
            kaggle_json.chmod(0o600)
            
            # FORCE environment variable to ensure CLI sees it
            os.environ['KAGGLE_CONFIG_DIR'] = str(kaggle_dir)
            
            log(f"Auth switched to: {account['username']}", "üîë")

        def run_cmd(cmd, timeout=180):
            try:
                # Capture both stdout and stderr
                result = subprocess.run(
                    cmd, 
                    shell=True, 
                    capture_output=True, 
                    text=True, 
                    timeout=timeout
                )
                return result.returncode == 0, result.stdout.strip(), result.stderr.strip()
            except subprocess.TimeoutExpired:
                return False, "", "Timeout expired"
            except Exception as e:
                return False, "", str(e)

        def execute_notebook(nb):
            log(f"STARTING: {nb['notebook_name']}", "üöÄ")
            
            source_dir = Path(f"./source_{nb['notebook_name']}")
            dest_dir = Path(f"./dest_{nb['notebook_name']}")
            original_dir = os.getcwd()
            
            try:
                # Clean directories
                for d in [source_dir, dest_dir]:
                    if d.exists():
                        shutil.rmtree(d)
                    d.mkdir()
                
                # --- PHASE 1: CHECK DESTINATION ---
                target_account_key = nb['dest_account']
                dest_account = DEST_ACCOUNTS[target_account_key]
                setup_kaggle_auth(dest_account)
                
                log(f"Checking destination: {nb['dest_slug']}", "üßê")
                success, stdout, stderr = run_cmd(f"kaggle kernels pull {nb['dest_slug']} -p {dest_dir} -m")
                
                dest_exists = success
                if dest_exists:
                    log("Destination kernel found (Updating)", "‚úÖ")
                else:
                    log("Destination kernel not found (Creating New)", "üÜï")

                # --- PHASE 2: PULL SOURCE ---
                setup_kaggle_auth(SOURCE_ACCOUNT)
                
                log(f"Pulling source: {nb['source_slug']}", "üì•")
                success, stdout, stderr = run_cmd(f"kaggle kernels pull {nb['source_slug']} -p {source_dir} -m")
                
                if not success:
                    log(f"SOURCE PULL FAILED!", "‚ùå")
                    log(f"Error Log: {stderr}", "üìù")
                    log(f"Output Log: {stdout}", "üìù")
                    
                    # DEBUG: List available kernels to help user fix slug
                    log("Listing available kernels for shreevathsbbhh to debug...", "üîç")
                    _, list_out, _ = run_cmd("kaggle kernels list --user shreevathsbbhh --sort-by dateRun")
                    print(list_out[:500] + "...") # Print first 500 chars
                    return False
                
                log("Source pull successful", "‚úÖ")
                
                # Find the notebook file
                source_notebooks = list(source_dir.glob("*.ipynb"))
                if not source_notebooks:
                    log("No .ipynb file found in source download!", "‚ùå")
                    return False
                source_notebook = source_notebooks[0]

                # --- PHASE 3: PREPARE METADATA ---
                if dest_exists:
                    # Update existing
                    dest_metadata_file = dest_dir / "kernel-metadata.json"
                    with open(dest_metadata_file, 'r') as f:
                        metadata = json.load(f)
                    
                    # Copy code
                    dest_nb_name = metadata.get('code_file', f"{nb['notebook_name']}.ipynb")
                    shutil.copy(source_notebook, dest_dir / dest_nb_name)
                    metadata['code_file'] = dest_nb_name
                    
                    with open(dest_metadata_file, 'w') as f:
                        json.dump(metadata, f, indent=2)
                    push_dir = dest_dir
                else:
                    # Create new
                    source_metadata_file = source_dir / "kernel-metadata.json"
                    with open(source_metadata_file, 'r') as f:
                        metadata = json.load(f)
                    
                    # Force ID to match destination slug
                    metadata['id'] = nb['dest_slug']
                    metadata.pop('id_no', None) # Remove old ID number
                    metadata['slug'] = nb['notebook_name']
                    metadata['title'] = nb['notebook_name']
                    metadata['code_file'] = source_notebook.name
                    
                    with open(source_metadata_file, 'w') as f:
                        json.dump(metadata, f, indent=2)
                    push_dir = source_dir

                # --- PHASE 4: PUSH ---
                setup_kaggle_auth(dest_account)
                
                os.chdir(push_dir)
                log(f"Pushing to {nb['dest_slug']}...", "üì§")
                success, stdout, stderr = run_cmd("kaggle kernels push", timeout=300)
                os.chdir(original_dir)
                
                if not success:
                    log("PUSH FAILED!", "‚ùå")
                    log(f"Stderr: {stderr}", "")
                    return False
                
                log(f"Successfully pushed: {nb['notebook_name']}", "‚úÖ")
                return True

            except Exception as e:
                log(f"CRITICAL ERROR: {e}", "‚ò†Ô∏è")
                return False
            finally:
                if os.getcwd() != original_dir:
                    os.chdir(original_dir)

        def execute_all():
            start = datetime.utcnow()
            log("--- BATCH EXECUTION STARTED ---", "üöÄ")
            
            results = {}
            for i, nb in enumerate(NOTEBOOKS):
                if i > 0:
                    log("Quick pause (1s)...", "‚è±Ô∏è")
                    time.sleep(1) # Reduced to 1 second as requested
                
                success = execute_notebook(nb)
                results[nb['notebook_name']] = success
                log("---------------------------------------------------", "")

            # Summary
            log("--- SUMMARY ---", "üìä")
            for name, status in results.items():
                icon = "‚úÖ" if status else "‚ùå"
                log(f"{icon} {name}")
            
            if not all(results.values()):
                sys.exit(1)

        execute_all()
        PYEOF
